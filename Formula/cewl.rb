class Cewl < Formula
  desc "Custom Word List generator"
  homepage "https://digi.ninja/projects/cewl.php"
  url "https://github.com/digininja/CeWL/archive/refs/tags/6.1.tar.gz"
  sha256 "15cc9c76e532be8ef6d8b64a96feb1cf12228aa5fb162ca4f0ad0b43e9cbab8b"
  license "GPL-3.0-or-later"

  depends_on "brew-gem"
  depends_on "ruby@3"

  resource "bundler" do
    url "https://rubygems.org/downloads/bundler-2.3.11.gem"
    sha256 "75e790ddf37071288648eff2781db2a139e246ada01d6f16b9ea6b5e83d7e899"
  end

  def install
    ENV["GEM_HOME"] = libexec
    rm "Gemfile.lock"
    resources.each do |r|
      r.verify_download_integrity(r.fetch)
      args = ["--no-document", "--install-dir", libexec]
      system "gem", "install", r.cached_download, *args
    end

    system "ruby", libexec/"bin/bundle", "install", "--no-cache"

    inreplace "cewl.rb", "require_relative 'cewl_lib'", "require '#{libexec}/cewl_lib'"
    inreplace "fab.rb", "require_relative \"./cewl_lib.rb\"", "require '#{libexec}/cewl_lib.rb'"

    (bin/"cewl").write <<~EOS
      #!/usr/bin/env bash
      export GEM_HOME="#{libexec}"
      export BUNDLE_GEMFILE="#{libexec}/Gemfile"
      #{libexec}/bin/bundle exec ruby #{libexec}/cewl.rb "$@"
    EOS
    (bin/"fab").write <<~EOS
      #!/usr/bin/env bash
      export GEM_HOME="#{libexec}"
      export BUNDLE_GEMFILE="#{libexec}/Gemfile"
      #{libexec}/bin/bundle exec ruby #{libexec}/fab.rb "$@"
    EOS

    libexec.install Dir["*"]
  end

  test do
    assert_match "Robin Wood (robin@digi.ninja) (https://digi.ninja/)", shell_output("#{bin}/cewl -h")
  end
end
