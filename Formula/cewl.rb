class Cewl < Formula
  desc "Custom Word List generator"
  homepage "https://digi.ninja/projects/cewl.php"
  url "https://github.com/digininja/CeWL/archive/refs/tags/6.1.tar.gz"
  sha256 "15cc9c76e532be8ef6d8b64a96feb1cf12228aa5fb162ca4f0ad0b43e9cbab8b"
  license "GPL-3.0-or-later"

  depends_on "ruby"

  on_linux do
    depends_on "brew-gem"
  end

  resource "rexml" do
    url "https://rubygems.org/downloads/rexml-3.2.6.gem"
    sha256 "e0669a2d4e9f109951cb1fde723d8acd285425d81594a2ea929304af50282816"
  end

  resource "racc" do
    url "https://rubygems.org/downloads/racc-1.7.3.gem"
    sha256 "b785ab8a30ec43bce073c51dbbe791fd27000f68d1c996c95da98bf685316905"
  end

  def install
    ENV["GEM_HOME"] = libexec
    resources.each do |r|
      r.verify_download_integrity(r.fetch)
      args = ["--no-document", "--install-dir", libexec]
      system "gem", "install", r.cached_download, *args
    end

    rm "Gemfile.lock"
    system "bundle", "install", "--no-cache"

    inreplace "cewl.rb", "require_relative 'cewl_lib'", "require '#{libexec}/cewl_lib'"
    inreplace "fab.rb", "require_relative \"./cewl_lib.rb\"", "require '#{libexec}/cewl_lib.rb'"

    (bin/"cewl").write <<~EOS
      #!/usr/bin/env bash
      export GEM_HOME="#{libexec}"
      export BUNDLE_GEMFILE="#{libexec}/Gemfile"
      bundle exec ruby #{libexec}/cewl.rb "$@"
    EOS
    (bin/"fab").write <<~EOS
      #!/usr/bin/env bash
      export GEM_HOME="#{libexec}"
      export BUNDLE_GEMFILE="#{libexec}/Gemfile"
      bundle exec ruby #{libexec}/fab.rb "$@"
    EOS

    libexec.install Dir["*"]
  end

  test do
    assert_match "Robin Wood (robin@digi.ninja) (https://digi.ninja/)", shell_output("#{bin}/cewl -h")
  end
end
